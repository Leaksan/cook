<!doctype html>
<html lang="fr">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>{% block title %}The Sauce{% endblock %}</title>
        <link
            rel="stylesheet"
            href="{{ url_for('static', filename='css/style.css') }}"
        />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"
        />
        <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.6.0/socket.io.min.js"></script>
        <style>
            /* Notifications Styles */
            .nav-notifications {
                position: relative;
            }
            .notification-dropdown {
                position: relative;
            }
            .notification-btn {
                position: relative;
                background: none;
                border: none;
                cursor: pointer;
                padding: 0.5rem;
            }
            .notification-badge {
                position: absolute;
                top: 0;
                right: 0;
                background: var(--danger-color, #e74c3c);
                color: white;
                font-size: 0.7rem;
                padding: 0.1rem 0.4rem;
                border-radius: 50%;
                min-width: 18px;
                text-align: center;
            }
            .notification-menu {
                display: none;
                position: absolute;
                top: 100%;
                right: 0;
                width: 350px;
                max-height: 450px;
                background: var(--bg-card, #1a1a2e);
                border: 1px solid var(--border-color, #333);
                border-radius: var(--border-radius, 8px);
                box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
                z-index: 1000;
                overflow: hidden;
            }
            .notification-menu.active {
                display: block;
            }
            .notification-header {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 1rem;
                border-bottom: 1px solid var(--border-color, #333);
            }
            .notification-header h4 {
                margin: 0;
                font-size: 1rem;
            }
            .notification-header .btn-link {
                background: none;
                border: none;
                color: var(--primary-color, #6c5ce7);
                cursor: pointer;
                font-size: 0.8rem;
            }
            .notification-list {
                max-height: 300px;
                overflow-y: auto;
            }
            .notification-item {
                display: flex;
                gap: 0.75rem;
                padding: 0.75rem 1rem;
                border-bottom: 1px solid var(--border-color, #333);
                cursor: pointer;
                transition: background 0.2s;
            }
            .notification-item:hover {
                background: var(--bg-darker, #0f0f1a);
            }
            .notification-item.unread {
                background: rgba(108, 92, 231, 0.1);
            }
            .notification-item .notif-avatar {
                width: 40px;
                height: 40px;
                border-radius: 50%;
                background: var(--bg-darker, #0f0f1a);
                display: flex;
                align-items: center;
                justify-content: center;
                flex-shrink: 0;
            }
            .notification-item .notif-avatar img {
                width: 100%;
                height: 100%;
                border-radius: 50%;
                object-fit: cover;
            }
            .notification-item .notif-content {
                flex: 1;
                min-width: 0;
            }
            .notification-item .notif-content p {
                margin: 0;
                font-size: 0.9rem;
                line-height: 1.4;
            }
            .notification-item .notif-content .notif-time {
                font-size: 0.75rem;
                color: var(--text-muted, #888);
                margin-top: 0.25rem;
            }
            .notification-item .notif-icon {
                color: var(--primary-color, #6c5ce7);
            }
            .notification-item .notif-icon.comment {
                color: var(--accent-color, #00cec9);
            }
            .notification-item .notif-icon.like {
                color: var(--danger-color, #e74c3c);
            }
            .notification-empty {
                padding: 2rem;
                text-align: center;
                color: var(--text-muted, #888);
            }
            .notification-empty i {
                font-size: 2rem;
                margin-bottom: 0.5rem;
                opacity: 0.5;
            }
            .notification-footer {
                padding: 0.75rem;
                text-align: center;
                border-top: 1px solid var(--border-color, #333);
            }
            .notification-footer a {
                color: var(--primary-color, #6c5ce7);
                font-size: 0.85rem;
            }
        </style>
        {% block head %}{% endblock %}
    </head>
    <body>
        <!-- Navbar -->
        <nav class="navbar">
            <a href="{{ url_for('index') }}" class="navbar-brand">
                <i class="fas fa-pepper-hot"></i>
                The Sauce
            </a>

            <ul class="navbar-nav">
                <li>
                    <a
                        href="{{ url_for('index') }}"
                        class="nav-link {% if request.endpoint == 'index' %}active{% endif %}"
                    >
                        <i class="fas fa-home"></i>
                        <span>Accueil</span>
                    </a>
                </li>
                <li>
                    <a
                        href="{{ url_for('publications') }}"
                        class="nav-link {% if request.endpoint == 'publications' %}active{% endif %}"
                    >
                        <i class="fas fa-video"></i>
                        <span>Vidéos</span>
                    </a>
                </li>
                {% if session.get('username') %}
                <li>
                    <a
                        href="{{ url_for('rencontres') }}"
                        class="nav-link {% if request.endpoint == 'rencontres' %}active{% endif %}"
                    >
                        <i class="fas fa-users"></i>
                        <span>Rencontres</span>
                    </a>
                </li>
                {% endif %} {% if session.get('username') %}
                <li>
                    <a
                        href="{{ url_for('upload') }}"
                        class="nav-link {% if request.endpoint == 'upload' %}active{% endif %}"
                    >
                        <i class="fas fa-cloud-upload-alt"></i>
                        <span>Publier</span>
                    </a>
                </li>

                <!-- Notifications -->
                <li class="nav-notifications">
                    <div class="notification-dropdown">
                        <button
                            class="nav-link notification-btn"
                            onclick="toggleNotifications()"
                        >
                            <i class="fas fa-bell"></i>
                            <span
                                class="notification-badge"
                                id="notifBadge"
                                style="display: none"
                                >0</span
                            >
                        </button>
                        <div class="notification-menu" id="notificationMenu">
                            <div class="notification-header">
                                <h4>Notifications</h4>
                                <button
                                    class="btn-link"
                                    onclick="markAllAsRead()"
                                >
                                    Tout marquer lu
                                </button>
                            </div>
                            <div
                                class="notification-list"
                                id="notificationList"
                            >
                                <div class="notification-empty">
                                    <i class="fas fa-bell-slash"></i>
                                    <p>Aucune notification</p>
                                </div>
                            </div>
                            <div class="notification-footer">
                                <a href="{{ url_for('notifications') }}"
                                    >Voir toutes les notifications</a
                                >
                            </div>
                        </div>
                    </div>
                </li>

                {% if session.get('role') == 'admin' %}
                <li>
                    <a
                        href="{{ url_for('admin') }}"
                        class="nav-link {% if 'admin' in request.endpoint %}active{% endif %}"
                    >
                        <i class="fas fa-cog"></i>
                        <span>Admin</span>
                    </a>
                </li>
                {% endif %}

                <li class="nav-user">
                    <a href="{{ url_for('profile') }}" class="nav-link">
                        <i class="fas fa-user-circle"></i>
                        <span
                            >{{ session.get('fullname', session.get('username'))
                            }}</span
                        >
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('logout') }}" class="nav-link">
                        <i class="fas fa-sign-out-alt"></i>
                    </a>
                </li>
                {% else %}
                <li>
                    <a href="{{ url_for('login') }}" class="nav-link">
                        <i class="fas fa-sign-in-alt"></i>
                        <span>Connexion</span>
                    </a>
                </li>
                <li>
                    <a
                        href="{{ url_for('register') }}"
                        class="btn btn-primary btn-sm"
                    >
                        <i class="fas fa-user-plus"></i>
                        <span>Inscription</span>
                    </a>
                </li>
                {% endif %}
            </ul>
        </nav>

        <!-- Main Content -->
        <main class="main-container">
            <!-- Flash Messages -->
            {% with messages = get_flashed_messages(with_categories=true) %} {%
            if messages %} {% for category, message in messages %}
            <div class="alert alert-{{ category }}">
                <i
                    class="fas {% if category == 'success' %}fa-check-circle{% elif category == 'danger' %}fa-exclamation-circle{% elif category == 'warning' %}fa-exclamation-triangle{% else %}fa-info-circle{% endif %}"
                ></i>
                {{ message }}
            </div>
            {% endfor %} {% endif %} {% endwith %} {% block content %}{%
            endblock %}
        </main>

        <!-- Call Modal -->
        <div class="modal-overlay" id="callModal">
            <div class="modal call-modal">
                <div class="user-avatar-placeholder" id="callerAvatar">
                    <i class="fas fa-user"></i>
                </div>
                <h3 id="callerName">Appel entrant</h3>
                <p id="callStatus">Quelqu'un vous appelle...</p>
                <div class="call-actions">
                    <button class="call-btn reject" onclick="rejectCall()">
                        <i class="fas fa-phone-slash"></i>
                    </button>
                    <button class="call-btn accept" onclick="acceptCall()">
                        <i class="fas fa-phone"></i>
                    </button>
                </div>
            </div>
        </div>

        <script>
            // Socket.IO connection
            {% if session.get('username') %}
            const socket = io();
            let incomingCallData = null;

            socket.on('connect', function() {
                console.log('Connected to server');
            });

            socket.on('user_online', function(data) {
                console.log(data.username + ' is now online');
                updateOnlineStatus(data.username, true);
            });

            socket.on('user_offline', function(data) {
                console.log(data.username + ' is now offline');
                updateOnlineStatus(data.username, false);
            });

            socket.on('incoming_call', function(data) {
                incomingCallData = data;
                document.getElementById('callerName').textContent = data.caller_fullname || data.caller;
                document.getElementById('callStatus').textContent = data.caller + ' vous appelle...';
                document.getElementById('callModal').classList.add('active');
            });

            function updateOnlineStatus(username, isOnline) {
                const userCards = document.querySelectorAll(`[data-username="${username}"]`);
                userCards.forEach(card => {
                    if (isOnline) {
                        card.classList.add('online');
                    } else {
                        card.classList.remove('online');
                    }
                });
            }

            function acceptCall() {
                if (incomingCallData) {
                    socket.emit('call_response', {
                        caller: incomingCallData.caller,
                        accepted: true,
                        room: incomingCallData.room
                    });
                    window.location.href = '/chat/' + incomingCallData.caller;
                }
                document.getElementById('callModal').classList.remove('active');
            }

            function rejectCall() {
                if (incomingCallData) {
                    socket.emit('call_response', {
                        caller: incomingCallData.caller,
                        accepted: false,
                        room: incomingCallData.room
                    });
                }
                document.getElementById('callModal').classList.remove('active');
                incomingCallData = null;
            }

            // ============== Notifications ==============

            // Charger les notifications au démarrage
            loadNotifications();

            // Écouter les nouvelles notifications via Socket
            socket.on('new_notification', function(data) {
                addNotificationToList(data);
                updateNotificationBadge();
                // Jouer un son optionnel
                playNotificationSound();
            });

            function loadNotifications() {
                fetch('/api/notifications')
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            renderNotifications(data.notifications);
                            updateNotificationBadge(data.unread_count);
                        }
                    })
                    .catch(error => console.error('Error loading notifications:', error));
            }

            function renderNotifications(notifications) {
                const list = document.getElementById('notificationList');
                if (!notifications || notifications.length === 0) {
                    list.innerHTML = `
                        <div class="notification-empty">
                            <i class="fas fa-bell-slash"></i>
                            <p>Aucune notification</p>
                        </div>
                    `;
                    return;
                }

                list.innerHTML = notifications.map(notif => `
                    <div class="notification-item ${notif.is_read ? '' : 'unread'}"
                         onclick="handleNotificationClick(${notif.id}, '${notif.type}', ${notif.publication_id || 'null'}, '${notif.sender_username || ''}')">
                        <div class="notif-avatar">
                            ${notif.sender_avatar
                                ? `<img src="/static/avatars/${notif.sender_avatar}" alt="">`
                                : `<i class="fas fa-user"></i>`}
                        </div>
                        <div class="notif-content">
                            <p>${escapeHtmlNotif(notif.content)}</p>
                            <div class="notif-time">${notif.time_ago}</div>
                        </div>
                        <div class="notif-icon ${notif.type}">
                            <i class="fas ${getNotificationIcon(notif.type)}"></i>
                        </div>
                    </div>
                `).join('');
            }

            function getNotificationIcon(type) {
                switch(type) {
                    case 'message': return 'fa-envelope';
                    case 'comment': return 'fa-comment';
                    case 'like': return 'fa-heart';
                    case 'follow': return 'fa-user-plus';
                    default: return 'fa-bell';
                }
            }

            function escapeHtmlNotif(text) {
                const div = document.createElement('div');
                div.textContent = text;
                return div.innerHTML;
            }

            function updateNotificationBadge(count) {
                const badge = document.getElementById('notifBadge');
                if (count === undefined) {
                    fetch('/api/notifications/count')
                        .then(response => response.json())
                        .then(data => {
                            if (data.count > 0) {
                                badge.textContent = data.count > 99 ? '99+' : data.count;
                                badge.style.display = 'block';
                            } else {
                                badge.style.display = 'none';
                            }
                        });
                } else {
                    if (count > 0) {
                        badge.textContent = count > 99 ? '99+' : count;
                        badge.style.display = 'block';
                    } else {
                        badge.style.display = 'none';
                    }
                }
            }

            function toggleNotifications() {
                const menu = document.getElementById('notificationMenu');
                menu.classList.toggle('active');
                if (menu.classList.contains('active')) {
                    loadNotifications();
                }
            }

            function handleNotificationClick(notifId, type, publicationId, senderUsername) {
                // Marquer comme lu
                fetch(`/api/notifications/${notifId}/read`, { method: 'POST' });

                // Rediriger selon le type
                if (type === 'message' && senderUsername) {
                    window.location.href = `/chat/${senderUsername}`;
                } else if ((type === 'comment' || type === 'like') && publicationId) {
                    window.location.href = `/watch/${publicationId}`;
                }

                toggleNotifications();
            }

            function markAllAsRead() {
                fetch('/api/notifications/read-all', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            loadNotifications();
                            updateNotificationBadge(0);
                        }
                    });
            }

            function addNotificationToList(notif) {
                const list = document.getElementById('notificationList');
                const emptyState = list.querySelector('.notification-empty');
                if (emptyState) {
                    emptyState.remove();
                }

                const notifHtml = `
                    <div class="notification-item unread"
                         onclick="handleNotificationClick(${notif.id}, '${notif.type}', ${notif.publication_id || 'null'}, '${notif.sender_username || ''}')">
                        <div class="notif-avatar">
                            ${notif.sender_avatar
                                ? `<img src="/static/avatars/${notif.sender_avatar}" alt="">`
                                : `<i class="fas fa-user"></i>`}
                        </div>
                        <div class="notif-content">
                            <p>${escapeHtmlNotif(notif.content)}</p>
                            <div class="notif-time">À l'instant</div>
                        </div>
                        <div class="notif-icon ${notif.type}">
                            <i class="fas ${getNotificationIcon(notif.type)}"></i>
                        </div>
                    </div>
                `;
                list.insertAdjacentHTML('afterbegin', notifHtml);
            }

            function playNotificationSound() {
                // Optionnel: jouer un son
                // const audio = new Audio('/static/sounds/notification.mp3');
                // audio.volume = 0.3;
                // audio.play().catch(() => {});
            }

            // Fermer le menu en cliquant ailleurs
            document.addEventListener('click', function(e) {
                const dropdown = document.querySelector('.notification-dropdown');
                const menu = document.getElementById('notificationMenu');
                if (dropdown && !dropdown.contains(e.target) && menu.classList.contains('active')) {
                    menu.classList.remove('active');
                }
            });
            {% endif %}
        </script>

        {% block scripts %}{% endblock %}
    </body>
</html>
