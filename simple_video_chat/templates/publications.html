{% extends "base.html" %} {% block title %}Gestion des publications - The
Sauce{% endblock %} {% block content %}
<div class="page-header">
    <h1>
        <i class="fas fa-video"></i>
        Gestion des publications
    </h1>
</div>

<div class="admin-layout">
    <!-- Sidebar -->
    <aside class="admin-sidebar">
        <nav>
            <ul class="admin-nav">
                <li>
                    <a href="{{ url_for('admin') }}" class="admin-nav-link">
                        <i class="fas fa-tachometer-alt"></i>
                        Tableau de bord
                    </a>
                </li>
                <li>
                    <a
                        href="{{ url_for('admin_users') }}"
                        class="admin-nav-link"
                    >
                        <i class="fas fa-users"></i>
                        Utilisateurs
                    </a>
                </li>
                <li>
                    <a
                        href="{{ url_for('admin_publications') }}"
                        class="admin-nav-link active"
                    >
                        <i class="fas fa-video"></i>
                        Publications
                    </a>
                </li>
                <li>
                    <a
                        href="{{ url_for('admin_categories') }}"
                        class="admin-nav-link"
                    >
                        <i class="fas fa-folder"></i>
                        Catégories
                    </a>
                </li>
                <li>
                    <a href="{{ url_for('index') }}" class="admin-nav-link">
                        <i class="fas fa-home"></i>
                        Retour au site
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <div class="admin-content">
        <div class="d-flex justify-between align-center mb-4">
            <h2>
                <i class="fas fa-film"></i>
                Publications ({{ publications|length }})
            </h2>
            <div class="d-flex gap-1">
                <select
                    id="statusFilter"
                    class="form-control"
                    style="width: 150px"
                    onchange="filterPublications()"
                >
                    <option value="all">Tous les statuts</option>
                    <option value="pending">En attente</option>
                    <option value="approved">Approuvées</option>
                    <option value="rejected">Rejetées</option>
                </select>
                <input
                    type="text"
                    class="form-control"
                    id="searchInput"
                    placeholder="Rechercher..."
                    style="width: 200px"
                    onkeyup="filterPublications()"
                />
            </div>
        </div>

        <!-- Pending Publications Alert -->
        {% set pending_count = publications|selectattr('status', 'equalto',
        'pending')|list|length %} {% if pending_count > 0 %}
        <div class="alert alert-warning mb-4">
            <i class="fas fa-exclamation-triangle"></i>
            <strong
                >{{ pending_count }} publication(s) en attente de
                validation</strong
            >
        </div>
        {% endif %}

        <!-- Publications Table -->
        {% if publications %}
        <div class="table-container">
            <table class="table" id="publicationsTable">
                <thead>
                    <tr>
                        <th>Aperçu</th>
                        <th>Titre</th>
                        <th>Auteur</th>
                        <th>Statut</th>
                        <th>Stats</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for pub in publications %}
                    <tr
                        data-id="{{ pub.id }}"
                        data-title="{{ pub.title|lower }}"
                        data-username="{{ pub.username|lower }}"
                        data-status="{{ pub.status }}"
                    >
                        <td>
                            <div
                                class="video-thumbnail"
                                style="
                                    width: 120px;
                                    height: 68px;
                                    border-radius: 8px;
                                    overflow: hidden;
                                "
                            >
                                <video
                                    preload="metadata"
                                    muted
                                    style="
                                        width: 100%;
                                        height: 100%;
                                        object-fit: cover;
                                    "
                                >
                                    <source
                                        src="{{ url_for('static', filename='uploads/' + pub.filename) }}#t=0.5"
                                        type="video/mp4"
                                    />
                                </video>
                            </div>
                        </td>
                        <td>
                            <div>
                                <strong>{{ pub.title }}</strong>
                                {% if pub.description %}
                                <br />
                                <span
                                    class="text-muted"
                                    style="font-size: 0.8rem"
                                >
                                    {{ pub.description[:50] }}{% if
                                    pub.description|length > 50 %}...{% endif %}
                                </span>
                                {% endif %}
                            </div>
                        </td>
                        <td>
                            <a
                                href="{{ url_for('view_user', username=pub.username) }}"
                                class="d-flex align-center gap-1"
                            >
                                <div
                                    class="user-avatar-placeholder"
                                    style="
                                        width: 30px;
                                        height: 30px;
                                        font-size: 0.8rem;
                                    "
                                >
                                    <i class="fas fa-user"></i>
                                </div>
                                <span>{{ pub.username }}</span>
                            </a>
                        </td>
                        <td>
                            {% if pub.status == 'approved' %}
                            <span class="badge badge-success">
                                <i class="fas fa-check"></i> Approuvée
                            </span>
                            {% elif pub.status == 'pending' %}
                            <span class="badge badge-warning">
                                <i class="fas fa-hourglass-half"></i> En attente
                            </span>
                            {% else %}
                            <span class="badge badge-danger">
                                <i class="fas fa-times"></i> Rejetée
                            </span>
                            {% endif %}
                        </td>
                        <td>
                            <div class="text-muted" style="font-size: 0.85rem">
                                <span title="Vues"
                                    ><i class="fas fa-eye"></i> {{ pub.views
                                    }}</span
                                >
                                <br />
                                <span title="J'aime"
                                    ><i class="fas fa-heart"></i> {{ pub.likes
                                    }}</span
                                >
                            </div>
                        </td>
                        <td>
                            <span class="text-muted" style="font-size: 0.85rem">
                                {{ pub.created_at.strftime('%d/%B/%Y') }}
                            </span>
                        </td>
                        <td>
                            <div class="d-flex gap-1" style="flex-wrap: wrap">
                                <!-- View -->
                                <a
                                    href="{{ url_for('watch', pub_id=pub.id) }}"
                                    class="btn btn-outline btn-sm"
                                    title="Voir"
                                >
                                    <i class="fas fa-play"></i>
                                </a>

                                {% if pub.status != 'approved' %}
                                <!-- Approve -->
                                <form
                                    method="POST"
                                    action="{{ url_for('admin_approve_publication', pub_id=pub.id) }}"
                                    style="display: inline"
                                >
                                    <button
                                        type="submit"
                                        class="btn btn-success btn-sm"
                                        title="Approuver"
                                    >
                                        <i class="fas fa-check"></i>
                                    </button>
                                </form>
                                {% endif %} {% if pub.status != 'rejected' %}
                                <!-- Reject -->
                                <form
                                    method="POST"
                                    action="{{ url_for('admin_reject_publication', pub_id=pub.id) }}"
                                    style="display: inline"
                                >
                                    <button
                                        type="submit"
                                        class="btn btn-outline btn-sm"
                                        title="Rejeter"
                                    >
                                        <i class="fas fa-ban"></i>
                                    </button>
                                </form>
                                {% endif %}

                                <!-- Delete -->
                                <form
                                    method="POST"
                                    action="{{ url_for('admin_delete_publication', pub_id=pub.id) }}"
                                    style="display: inline"
                                    onsubmit="return confirmDelete('{{ pub.title }}')"
                                >
                                    <button
                                        type="submit"
                                        class="btn btn-danger btn-sm"
                                        title="Supprimer"
                                    >
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
        {% else %}
        <div class="empty-state">
            <i class="fas fa-film"></i>
            <h3>Aucune publication</h3>
            <p class="text-muted">
                Il n'y a pas encore de publications sur la plateforme.
            </p>
        </div>
        {% endif %}

        <!-- No Results Message -->
        <div class="empty-state hidden" id="noResults">
            <i class="fas fa-search"></i>
            <h3>Aucun résultat</h3>
            <p>Aucune publication ne correspond à votre recherche.</p>
        </div>

        <!-- Legend -->
        <div class="card mt-4">
            <div class="card-header">
                <h4 class="card-title">
                    <i class="fas fa-info-circle"></i>
                    Légende des actions
                </h4>
            </div>
            <div class="d-flex gap-2" style="flex-wrap: wrap">
                <span class="text-muted">
                    <i class="fas fa-play"></i> Voir la vidéo
                </span>
                <span class="text-muted">•</span>
                <span class="text-muted">
                    <i class="fas fa-check"></i> Approuver la publication
                </span>
                <span class="text-muted">•</span>
                <span class="text-muted">
                    <i class="fas fa-ban"></i> Rejeter la publication
                </span>
                <span class="text-muted">•</span>
                <span class="text-muted">
                    <i class="fas fa-trash"></i> Supprimer définitivement
                </span>
            </div>
        </div>

        <!-- Bulk Actions -->
        {% if publications %}
        <div class="card mt-4">
            <div class="card-header">
                <h4 class="card-title">
                    <i class="fas fa-tasks"></i>
                    Actions en masse
                </h4>
            </div>
            <div class="d-flex gap-2" style="flex-wrap: wrap">
                <button
                    class="btn btn-success btn-sm"
                    onclick="approveAllPending()"
                >
                    <i class="fas fa-check-double"></i>
                    Approuver toutes les publications en attente
                </button>
                <button
                    class="btn btn-danger btn-sm"
                    onclick="deleteAllRejected()"
                >
                    <i class="fas fa-trash"></i>
                    Supprimer toutes les publications rejetées
                </button>
            </div>
        </div>
        {% endif %}
    </div>
</div>
{% endblock %} {% block scripts %}
<script>
    function filterPublications() {
        const searchValue = document
            .getElementById("searchInput")
            .value.toLowerCase();
        const statusFilter = document.getElementById("statusFilter").value;
        const rows = document.querySelectorAll("#publicationsTable tbody tr");
        let visibleCount = 0;

        rows.forEach((row) => {
            const title = row.dataset.title;
            const username = row.dataset.username;
            const status = row.dataset.status;

            const matchesSearch =
                title.includes(searchValue) || username.includes(searchValue);
            const matchesStatus =
                statusFilter === "all" || status === statusFilter;

            if (matchesSearch && matchesStatus) {
                row.style.display = "";
                visibleCount++;
            } else {
                row.style.display = "none";
            }
        });

        // Show/hide no results message
        const noResults = document.getElementById("noResults");
        const tableContainer = document.querySelector(".table-container");

        if (tableContainer) {
            if (visibleCount === 0) {
                noResults.classList.remove("hidden");
                tableContainer.style.display = "none";
            } else {
                noResults.classList.add("hidden");
                tableContainer.style.display = "";
            }
        }
    }

    function confirmDelete(title) {
        return confirm(
            'Êtes-vous sûr de vouloir supprimer la publication "' +
                title +
                '" ?\n\nCette action est irréversible et le fichier vidéo sera également supprimé.',
        );
    }

    function approveAllPending() {
        if (
            confirm(
                "Êtes-vous sûr de vouloir approuver toutes les publications en attente ?",
            )
        ) {
            const pendingRows = document.querySelectorAll(
                '#publicationsTable tbody tr[data-status="pending"]',
            );
            pendingRows.forEach((row) => {
                const form = row.querySelector('form[action*="approve"]');
                if (form) {
                    form.submit();
                }
            });
        }
    }

    function deleteAllRejected() {
        if (
            confirm(
                "Êtes-vous sûr de vouloir supprimer toutes les publications rejetées ?\n\nCette action est irréversible !",
            )
        ) {
            const rejectedRows = document.querySelectorAll(
                '#publicationsTable tbody tr[data-status="rejected"]',
            );
            rejectedRows.forEach((row) => {
                const form = row.querySelector('form[action*="delete"]');
                if (form) {
                    form.submit();
                }
            });
        }
    }

    // Auto-load video thumbnails
    document.querySelectorAll(".video-thumbnail video").forEach((video) => {
        video.addEventListener("loadedmetadata", function () {
            this.currentTime = 0.5;
        });
    });
</script>
{% endblock %}
